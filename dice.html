function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    const numberCode = data.numberCode || '未提供';
    const nameTail = data.nameTail || '未提供';
    const isWin = data.isWin;
    const ip = data.ip || '無法獲取';

    const now = new Date();
    const date = Utilities.formatDate(now, "Asia/Taipei", "yyyy-MM-dd");
    const time = Utilities.formatDate(now, "Asia/Taipei", "HH:mm:ss");

    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName("抽獎記錄表");
    if (!sheet) {
      sheet = spreadsheet.getSheetByName("工作表1");
    }
    if (!sheet) {
      throw new Error("找不到名為 '抽獎記錄表' 或 '工作表1' 的工作表。");
    }

    if (sheet.getLastRow() === 0) {
      const headers = ["代碼", "IP", "日期", "是否中獎", "獎品", "時間", "姓名末兩字"];
      sheet.appendRow(headers);
    }
    
    const newRow = [
      numberCode, ip, date,
      isWin ? "是" : "否",
      isWin ? "波士頓花生奶油堡" : "無",
      time, nameTail
    ];
    
    sheet.appendRow(newRow);
    
    return ContentService.createTextOutput(JSON.stringify({ status: "success", message: "记录成功！" }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log("寫入 Google Sheet 時發生錯誤: " + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
